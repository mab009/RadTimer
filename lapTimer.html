<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radiologist Case Timer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #ffffff;
        }
        .container {
            text-align: center;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255,255,255,0.1);
            max-width: 800px;
            width: 100%;
        }
        #currentCaseDisplay {
            font-size: 3em;
            margin-bottom: 10px;
            transition: color 0.5s ease;
        }
        #totalTimeDisplay {
            font-size: 1.2em;
            color: #888;
            margin-bottom: 20px;
        }
        button {
            font-size: 1em;
            margin: 5px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #3700B3;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #6200EE;
        }
        #caseTimes, #statistics {
            margin-top: 20px;
            text-align: left;
        }
        .above-target {
            color: #ff6b6b;
        }
        .below-target {
            color: #4caf50;
        }
        .warning {
            color: #ffd700;
        }
        input[type="number"], input[type="time"], select {
            background-color: #2c2c2c;
            color: white;
            border: 1px solid #3700B3;
            padding: 5px;
            border-radius: 5px;
            width: 100px;
        }
        .shortcuts {
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #aaa;
            background-color: #2c2c2c;
            padding: 10px;
            border-radius: 5px;
        }
        .delete-case {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            margin-left: 10px;
            cursor: pointer;
        }
        .delete-case:hover {
            background-color: #cc0000;
        }
        @keyframes flash {
            0%, 100% { color: #ffffff; }
            50% { color: #ff6b6b; }
        }
        .flashing {
            animation: flash 1s linear infinite;
        }
        .settings {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .settings > div {
            flex: 1 1 200px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="shortcuts">
            <p>Shortcuts: Shift+Space (Complete Case) | Control+Space (Start/Stop)</p>
        </div>
        <div id="currentCaseDisplay">00:00:00</div>
        <div id="totalTimeDisplay">Total: 00:00:00</div>
        <button id="startStop">Start</button>
        <button id="completeCase">Complete Case</button>
        <button id="reset">Reset</button>
        <div class="settings">
            <div>
                <label for="timeInputType">Time Input Type:</label>
                <select id="timeInputType">
                    <option value="shiftEnd">Shift End Time</option>
                    <option value="totalTime">Total Time</option>
                </select>
            </div>
            <div id="shiftEndTimeWrapper">
                <label for="shiftEndTime">Shift End Time:</label>
                <input type="time" id="shiftEndTime" value="17:00">
            </div>
            <div id="totalTimeWrapper" style="display:none;">
                <label for="totalTime">Total Time (minutes):</label>
                <input type="number" id="totalTime" value="480" min="1" step="1">
            </div>
            <div>
                <label for="targetCases">Target Number of Cases:</label>
                <input type="number" id="targetCases" value="50" min="1" step="1">
            </div>
            <div>
                <label for="completedCases">Completed Cases:</label>
                <input type="number" id="completedCases" value="0" min="0" step="1">
            </div>
            <div>
                <label for="recentCasesAvg">Recent Cases for Avg:</label>
                <input type="number" id="recentCasesAvg" value="3" min="1" step="1">
            </div>
        </div>
        <div id="targetAverageTime"></div>
        <div id="statistics"></div>
        <div id="caseTimes"></div>
    </div>
</body>
<script>
    let startTime;
    let elapsedTime = 0;
    let timerInterval;
    let running = false;
    let caseTimes = [];
    let lastCaseTime = 0;
    let currentCaseStartTime = 0;
    let flashTimeout;
    let targetReached = false;

    const currentCaseDisplay = document.getElementById('currentCaseDisplay');
    const totalTimeDisplay = document.getElementById('totalTimeDisplay');
    const startStopButton = document.getElementById('startStop');
    const completeCaseButton = document.getElementById('completeCase');
    const resetButton = document.getElementById('reset');
    const caseTimesDiv = document.getElementById('caseTimes');
    const statisticsDiv = document.getElementById('statistics');
    const targetAverageTimeDiv = document.getElementById('targetAverageTime');
    const timeInputTypeSelect = document.getElementById('timeInputType');
    const shiftEndTimeWrapper = document.getElementById('shiftEndTimeWrapper');
    const totalTimeWrapper = document.getElementById('totalTimeWrapper');
    const shiftEndTimeInput = document.getElementById('shiftEndTime');
    const totalTimeInput = document.getElementById('totalTime');
    const targetCasesInput = document.getElementById('targetCases');
    const completedCasesInput = document.getElementById('completedCases');
    const recentCasesAvgInput = document.getElementById('recentCasesAvg');

    timeInputTypeSelect.addEventListener('change', function() {
        if (this.value === 'shiftEnd') {
            shiftEndTimeWrapper.style.display = 'block';
            totalTimeWrapper.style.display = 'none';
        } else {
            shiftEndTimeWrapper.style.display = 'none';
            totalTimeWrapper.style.display = 'block';
        }
        updateTargetAverageTime();
    });

    function startStop() {
        if (running) {
            clearInterval(timerInterval);
            elapsedTime += Date.now() - startTime;
            startStopButton.textContent = 'Start';
        } else {
            startTime = Date.now();
            if (caseTimes.length === 0) {
                currentCaseStartTime = startTime;
            }
            timerInterval = setInterval(updateDisplay, 1000);
            startStopButton.textContent = 'Stop';
        }
        running = !running;
    }

    function updateDisplay() {
        const currentTime = Date.now();
        const totalElapsedTime = elapsedTime + (currentTime - startTime);
        const currentCaseTime = totalElapsedTime - lastCaseTime;
        
        currentCaseDisplay.textContent = formatTime(currentCaseTime);
        totalTimeDisplay.textContent = 'Total: ' + formatTime(totalElapsedTime);

        checkTargetTime(currentCaseTime);
        updateStatistics(totalElapsedTime);
    }

    function checkTargetTime(currentCaseTime) {
        const targetTime = calculateTargetTimePerCase();
        if (currentCaseTime >= targetTime && !targetReached) {
            targetReached = true;
            startFlashing();
            setTimeout(stopFlashing, 30000);
        }
    }

    function startFlashing() {
        currentCaseDisplay.classList.add('flashing');
    }

    function stopFlashing() {
        currentCaseDisplay.classList.remove('flashing');
    }

    function formatTime(time) {
        const date = new Date(time);
        return date.toISOString().substr(11, 8);
    }

    function completeCase() {
        if (running) {
            const currentTime = Date.now();
            const caseTime = currentTime - startTime + elapsedTime - lastCaseTime;
            caseTimes.unshift(caseTime);
            lastCaseTime = currentTime - startTime + elapsedTime;
            currentCaseStartTime = currentTime;
            targetReached = false;
            stopFlashing();
            updateCaseTimes();
            updateStatistics(lastCaseTime);
            completedCasesInput.value = parseInt(completedCasesInput.value) + 1;
        }
    }

    function updateCaseTimes() {
        const targetTime = calculateTargetTimePerCase();
        caseTimesDiv.innerHTML = caseTimes.map((time, index) => {
            const formattedTime = formatTime(time);
            const className = time > targetTime ? 'above-target' : 'below-target';
            return `<div class="${className}">
                Case ${caseTimes.length - index}: ${formattedTime}
                <button class="delete-case" onclick="deleteCase(${index})">X</button>
            </div>`;
        }).join('');
    }

    function deleteCase(index) {
        caseTimes.splice(index, 1);
        updateCaseTimes();
        updateStatistics(lastCaseTime);
        completedCasesInput.value = parseInt(completedCasesInput.value) - 1;
    }

    function calculateTargetTimePerCase() {
        let totalTime;
        if (timeInputTypeSelect.value === 'shiftEnd') {
            const now = new Date();
            const shiftEnd = new Date(now.toDateString() + ' ' + shiftEndTimeInput.value);
            totalTime = shiftEnd - now;
        } else {
            totalTime = parseInt(totalTimeInput.value) * 60 * 1000; // Convert minutes to milliseconds
        }
        return totalTime / parseInt(targetCasesInput.value);
    }

    function updateTargetAverageTime() {
        const targetTime = calculateTargetTimePerCase();
        targetAverageTimeDiv.textContent = `Target Average Time per Case: ${formatTime(targetTime)}`;
    }

    function updateStatistics(totalElapsedTime) {
        const targetTime = calculateTargetTimePerCase();
        const completedCases = parseInt(completedCasesInput.value);
        const targetCases = parseInt(targetCasesInput.value);
        const recentCasesCount = parseInt(recentCasesAvgInput.value);

        let averageCaseTime = 0;
        let recentAverageCaseTime = 0;

        if (caseTimes.length > 0) {
            averageCaseTime = caseTimes.reduce((sum, time) => sum + time, 0) / caseTimes.length;
            recentAverageCaseTime = caseTimes.slice(0, recentCasesCount).reduce((sum, time) => sum + time, 0) / Math.min(recentCasesCount, caseTimes.length);
        }

        const totalTargetTime = targetTime * targetCases;
        const timeRemaining = Math.max(0, totalTargetTime - totalElapsedTime);

        const percentAtTargetAll = ((completedCases + timeRemaining / averageCaseTime) / targetCases) * 100;
        const percentAtTargetRecent = ((completedCases + timeRemaining / recentAverageCaseTime) / targetCases) * 100;
        
        const casesCompletedAtCurrentPace = completedCases +   timeRemaining / averageCaseTime;
        const casesCompletedAtRecentPace = completedCases + timeRemaining / recentAverageCaseTime;

        const getColorClass = (percent) => {
            if (percent >= 84) return 'below-target';
            if (percent >= 80) return 'warning';
            return 'above-target';
        };

        statisticsDiv.innerHTML = `
            <p>Completed Cases: ${completedCases} / ${targetCases} | 
               Avg Time: ${formatTime(averageCaseTime)} (All), ${formatTime(recentAverageCaseTime)} (Recent ${recentCasesCount})</p>
            <p class="${getColorClass(percentAtTargetAll)}">% at Target: ${percentAtTargetAll.toFixed(2)}% (All), 
               ${percentAtTargetRecent.toFixed(2)}% (Recent ${recentCasesCount})</p>
            <p>Cases Completed at Current Pace: ${casesCompletedAtCurrentPace.toFixed(2)} (All), ${casesCompletedAtRecentPace.toFixed(2)} (Recent ${recentCasesCount})</p>
        `;

        updateTargetAverageTime();
    }

    function reset() {
        clearInterval(timerInterval);
        elapsedTime = 0;
        running = false;
        caseTimes = [];
        lastCaseTime = 0;
        currentCaseStartTime = 0;
        targetReached = false;
        stopFlashing();
        currentCaseDisplay.textContent = '00:00:00';
        totalTimeDisplay.textContent = 'Total: 00:00:00';
        startStopButton.textContent = 'Start';
        caseTimesDiv.innerHTML = '';
        statisticsDiv.innerHTML = '';
        completedCasesInput.value = '0';
        updateTargetAverageTime();
    }

    startStopButton.addEventListener('click', startStop);
    completeCaseButton.addEventListener('click', completeCase);
    resetButton.addEventListener('click', reset);
    [shiftEndTimeInput, totalTimeInput, targetCasesInput, completedCasesInput, recentCasesAvgInput].forEach(input => {
        input.addEventListener('change', () => {
            updateStatistics(elapsedTime);
            updateTargetAverageTime();
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        if (event.shiftKey && event.code === 'Space' && !event.ctrlKey) {
            event.preventDefault();
            completeCase();
        }
        if (event.ctrlKey && event.code === 'Space' && !event.shiftKey) {
            event.preventDefault();
            startStop();
        }
    });

    // Initial statistics update
    updateStatistics(0);
    updateTargetAverageTime();
</script>
</html>
